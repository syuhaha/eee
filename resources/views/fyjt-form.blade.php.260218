<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>fyjt</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --card-bg: #ffffff;
      --card-shadow: 0 4px 6px -1px rgba(0,0,0,.07), 0 10px 20px -5px rgba(0,0,0,.08);
      --card-radius: 16px;
      --border: #e2e8f0;
      --txt: #1e293b;
      --txt-muted: #64748b;
      --err: #dc2626;
      --ok: #059669;
      --accent: #4f46e5;
      --accent-hover: #4338ca;
      --input-focus: #6366f1;
      --font: 'DM Sans', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--txt);
      min-height: 100vh;
      padding: 32px 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    .wrap { max-width: 560px; margin: 0 auto; }

    .card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 32px;
      border: 1px solid var(--border);
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 24px;
      color: var(--txt);
      letter-spacing: -0.02em;
    }

    .grid { display: flex; flex-direction: column; gap: 20px; }

    .form-group { display: flex; flex-direction: column; gap: 8px; }

    label { font-weight: 600; color: var(--txt); font-size: 18px; }

    input, textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      transition: border-color .2s, box-shadow .2s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .15);
    }

    input::placeholder, textarea::placeholder { color: #94a3b8; }

    textarea { min-height: 120px; resize: vertical; line-height: 1.5; }

    .hint { font-size: 12px; color: var(--txt-muted); margin-top: 2px; }
    .err { font-size: 13px; color: var(--err); margin-top: 4px; }

    .msg {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .msg.ok { background: #ecfdf5; color: var(--ok); border: 1px solid #a7f3d0; }
    .msg.bad { background: #fef2f2; color: var(--err); border: 1px solid #fecaca; }

    .disclaimer {
      font-size: 13px;
      color: var(--txt-muted);
      line-height: 1.7;
      background: #f8fafc;
      border: 1px solid var(--border);
      padding: 16px 18px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .disclaimer strong { color: var(--txt); font-size: 14px; }

    .captcha {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .captcha input { max-width: 140px; }

    .captcha img {
      height: 48px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: opacity .2s;
    }

    .captcha img:hover { opacity: .9; }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      font-family: inherit;
      transition: background .2s, transform .05s;
    }

    .btn:hover { background: var(--accent-hover); }
    .btn:active { transform: scale(.98); }

    .btn-outline {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .btn-outline:hover { background: rgba(79, 70, 229, .08); }

    .submit-wrap { margin-top: 28px; text-align: center; }
    .submit-wrap .btn { padding: 14px 32px; font-size: 16px; min-width: 160px; }

    .counter { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">fyjt</h1>

      @if(session('success'))
        <div class="msg ok">{{ session('success') }}</div>
      @endif

      @if($errors->any())
        <div class="msg bad">请检查表单输入后重试。</div>
      @endif

      <div class="disclaimer">
        <strong>科目1（免责文字）</strong><br>
        本页面用于提交信息。你确认所填内容真实有效；因填写信息错误、第三方不可用等导致的结果由提交方自行承担。
      </div>

      <form method="POST" action="{{ route('fyjt.submit') }}" id="fyjtForm">
        @csrf

        <div class="grid">
          <div class="form-group">
            <label>aaa（）</label>
            <input
              type="text"
              name="token"
              value="{{ old('token') }}"
              maxlength="64"
              pattern="[A-Za-z0-9]{1,64}"
              inputmode="latin"
              autocomplete="off"
              required
            >
            <div class="hint">仅允许半角英数字，长度不超过 64。</div>
            @error('token') <div class="err">{{ $message }}</div> @enderror
          </div>

          <div class="form-group">
            <label>bbb（）</label>
            <input
              type="email"
              name="email"
              value="{{ old('email') }}"
              placeholder="name@example.com"
              maxlength="200"
              autocomplete="email"
              required
            >
            <div class="hint">Email 必填，最长 200。</div>
            @error('email') <div class="err">{{ $message }}</div> @enderror
          </div>

          <div class="form-group">
            <label>ccc&nbsp;&nbsp;<span class="hint counter" id="field3Count">0 / 50</span></label>
            <input
              type="text"
              id="field3"
              name="field3"
              value="{{ old('field3') }}"
              maxlength="50"
              autocomplete="off"
              required
            >
            <div class="hint">仅允许数字/英文/中文字符，长度不超过 50。</div>
            @error('field3') <div class="err">{{ $message }}</div> @enderror
          </div>

          <div class="form-group">
            <label>ddd&nbsp;&nbsp;<span class="hint counter" id="field4Count">0 / 200</span></label>
            <textarea
              id="field4"
              name="field4"
              maxlength="200"
              required
              placeholder=""
            >{{ old('field4') }}</textarea>
            <div class="hint">必填，长度不超过 200。</div>
            @error('field4') <div class="err">{{ $message }}</div> @enderror
          </div>

          <div class="form-group">
            <label>CAPTCHA</label>
            <div class="captcha">
              <input
                type="text"
                name="captcha"
                maxlength="4"
                pattern="[A-Za-z0-9]{4}"
                inputmode="latin"
                autocomplete="off"
                required
              >
              <img id="captchaImg" src="{{ route('fyjt.captcha') }}?t={{ time() }}" alt="captcha" title="点击刷新">
              <button type="button" class="btn btn-outline" id="refreshBtn">刷新</button>
            </div>
            <div class="hint">点击验证码图片或“刷新”可更换验证码。</div>
            @error('captcha') <div class="err">{{ $message }}</div> @enderror
          </div>
        </div>

        <div class="submit-wrap">
          <button class="btn" type="submit">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function updateCount(id, outId, max){
      var el = document.getElementById(id);
      var out = document.getElementById(outId);
      if (!el || !out) return;
      function fn(){ out.textContent = el.value.length + ' / ' + max; }
      el.addEventListener('input', fn);
      fn();
    }
    updateCount('field3','field3Count',50);
    updateCount('field4','field4Count',200);

(function () {
  var img = document.getElementById('captchaImg');
  var btn = document.getElementById('refreshBtn');
  if (!img || !btn) return;

  var COOLDOWN_MS = 5000;
  var lastAt = 0;
  var timer = null;
  var btnText = btn.textContent;

  function setCooldown(remainMs) {
    clearInterval(timer);
    btn.disabled = true;

    timer = setInterval(function () {
      var now = Date.now();
      var left = Math.max(0, COOLDOWN_MS - (now - lastAt));
      if (left <= 0) {
        clearInterval(timer);
        btn.disabled = false;
        btn.textContent = btnText;
      } else {
        btn.textContent = btnText + '（' + Math.ceil(left / 1000) + 's）';
      }
    }, 200);
  }

  function doRefresh() {
    var now = Date.now();
    if (now - lastAt < COOLDOWN_MS) return; // 3 秒内直接忽略
    lastAt = now;

    img.src = "{{ route('fyjt.captcha') }}?t=" + now;
    setCooldown(COOLDOWN_MS);
  }

  img.addEventListener('click', doRefresh);
  btn.addEventListener('click', doRefresh);
})();

    // ===== 客户端合法性校验（体验增强，后端仍以 FormRequest 为准）=====
    (function () {
      var form = document.getElementById('fyjtForm');
      if (!form) return;

      function q(name){ return form.querySelector('[name="' + name + '"]'); }

      function setErr(el, msg){
        if (!el) return;
        el.setCustomValidity(msg || '');
      }

      function clearOnInput(el){
        if (!el) return;
        el.addEventListener('input', function(){ el.setCustomValidity(''); });
      }

      var elToken = q('token');
      var elEmail = q('email');
      var elField3 = q('field3');
      var elField4 = q('field4');
      var elCaptcha = q('captcha');

      [elToken, elEmail, elField3, elField4, elCaptcha].forEach(clearOnInput);

      // 让验证码自动大写（若你验证码只用大写字母更一致）
      if (elCaptcha) {
        elCaptcha.addEventListener('input', function () {
          elCaptcha.value = elCaptcha.value.toUpperCase();
        });
      }

      form.addEventListener('submit', function (e) {
        // 先清空自定义错误
        [elToken, elEmail, elField3, elField4, elCaptcha].forEach(function (el) { setErr(el, ''); });

        var token = (elToken && elToken.value ? elToken.value.trim() : '');
        var email = (elEmail && elEmail.value ? elEmail.value.trim() : '');
        var field3 = (elField3 && elField3.value ? elField3.value.trim() : '');
        var field4 = (elField4 && elField4.value ? elField4.value : '');
        var captcha = (elCaptcha && elCaptcha.value ? elCaptcha.value.trim() : '');

        var ok = true;

        // token：半角英数 1~64
        if (!/^[A-Za-z0-9]{1,64}$/.test(token)) {
          setErr(elToken, 'Token 必填，只能半角英数字，长度不超过 64。');
          ok = false;
        }

        // email：必填 + max 200（格式交给 type=email）
        if (email.length === 0) {
          setErr(elEmail, 'Email 必填。');
          ok = false;
        } else if (email.length > 200) {
          setErr(elEmail, 'Email 长度不能超过 200。');
          ok = false;
        }

        // 科目3：数字/英文/中文，<=50
        if (field3.length === 0) {
          setErr(elField3, '科目3 必填。');
          ok = false;
        } else if (field3.length > 50) {
          setErr(elField3, '科目3 长度不能超过 50。');
          ok = false;
        } else if (!/^[0-9A-Za-z\u4e00-\u9fa5]+$/.test(field3)) {
          setErr(elField3, '科目3 仅允许数字/英文/中文字符。');
          ok = false;
        }

        // 科目4：必填，可见字符（trim 后非空），<=200
        if (field4.trim().length === 0) {
          setErr(elField4, '科目4 必填。');
          ok = false;
        } else if (field4.length > 200) {
          setErr(elField4, '科目4 长度不能超过 200。');
          ok = false;
        }

        // captcha：4 位英数
        if (!/^[A-Za-z0-9]{4}$/.test(captcha)) {
          setErr(elCaptcha, '验证码必填，且为 4 位字母/数字。');
          ok = false;
        }

        if (!ok) {
          e.preventDefault();
          var firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) firstInvalid.reportValidity();
        }
      });
    })();
  </script>
</body>
</html>